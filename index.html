<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=, initial-scale=1.0">
    <title>Historial Clinico</title>
     <link rel="stylesheet" href="styles.css" />
</head>
<body>
   <!-- LOGIN -->
<div id="login">
  <h1>Acceso autorizado</h1>
  <input type="email" id="email" placeholder="Email"><br><br>
  <input type="password" id="password" placeholder="Contrase√±a"><br><br>
<button id="btnLogin">Ingresar</button>
<p id="error" style="color:red;"></p>


  <p id="error" style="color:red;"></p>
</div>

<!-- APP -->
<div id="app" style="display:none;">
  <h1>Historial Cl√≠nico</h1>
  <p class="subtitulo">Seleccion√° un paciente</p>

  <button onclick="logout()">Cerrar sesi√≥n</button>
  <br><br>
  
 <div class="buscador-container">
  <input
    type="text"
    id="buscador"
    placeholder="Buscar paciente‚Ä¶"
    onkeyup="filtrarPacientes()"
  >
</div>

  <div id="lista" class="grid">
    <div class="card" onclick="abrirPaciente(1)">Paciente 1</div>
    <div class="card" onclick="abrirPaciente(2)">Paciente 2</div>
    <div class="card" onclick="abrirPaciente(3)">Paciente 3</div>
     <div class="card" onclick="abrirPaciente(4)">Paciente 4</div>
    <div class="card" onclick="abrirPaciente(5)">Paciente 5</div>
    <div class="card" onclick="abrirPaciente(6)">Paciente 6</div>
    <div class="card" onclick="abrirPaciente(7)">Paciente 7</div>
    <div class="card" onclick="abrirPaciente(8)">Paciente 8</div>
    <div class="card" onclick="abrirPaciente(9)">Paciente 9</div>
     <div class="card" onclick="abrirPaciente(10)">Paciente 10</div>
    <div class="card" onclick="abrirPaciente(11)">Paciente 11</div>
  </div>

  <div id="editor" class="editor" style="display:none;">
    <h1 id="titulo"></h1>
    <p id="fecha" style="font-size:14px; color:gray;"></p>

    <textarea id="texto" disabled></textarea>

    <div class="botones">
      <button onclick="editar()">Editar</button>
      <button onclick="guardar()" id="btnGuardar" disabled>Guardar</button>
      <br><br>
      <button onclick="exportarPDF()">üìÑ Descargar PDF</button>
      <button onclick="volver()">‚Üê Volver</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCTvanae1ksxlApSyzR5aVDKz0ES5H_tug",
  authDomain: "historial-clinico-e7239.firebaseapp.com",
  projectId: "historial-clinico-e7239",
  storageBucket: "historial-clinico-e7239.firebasestorage.app",
  messagingSenderId: "971331712533",
  appId: "1:971331712533:web:626701c07f6860e445401c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let pacienteActual = null;

// üîê LOGIN
window.login = async () => {
  try {
    await signInWithEmailAndPassword(
      auth,
      email.value,
      password.value
    );
    error.innerText = "";
  } catch {
    error.innerText = "Acceso denegado: datos incorrectos";
  }
};

// üö™ LOGOUT
window.logout = async () => {
  await signOut(auth);
  email.value = "";
  password.value = "";
};

// üëÄ SESI√ìN
onAuthStateChanged(auth, (user) => {
  login.style.display = user ? "none" : "block";
  appDiv.style.display = user ? "block" : "none";
});

// üìÇ ABRIR PACIENTE
window.abrirPaciente = async (id) => {
  pacienteActual = id;
  lista.style.display = "none";
  editor.style.display = "block";
  titulo.innerText = `Paciente ${id}`;

  const ref = doc(db, "pacientes", "paciente_" + id);
  const snap = await getDoc(ref);

  texto.value = snap.exists() ? snap.data().historial || "" : "";
  fecha.innerText = snap.exists() && snap.data().ultimaActualizacion
    ? "√öltima actualizaci√≥n: " + snap.data().ultimaActualizacion
    : "Sin historial";

  texto.disabled = true;
  btnGuardar.disabled = true;
};

// ‚úèÔ∏è EDITAR (SIN AUTO-ESCRIBIR NADA)
window.editar = () => {
  texto.disabled = false;
  btnGuardar.disabled = false;

  const hoy = new Date().toLocaleDateString("es-AR");
  if (!texto.value.endsWith("\n") && texto.value !== "") {
    texto.value += "\n";
  }
  texto.value += hoy + ": ";

  texto.focus();
  texto.selectionStart = texto.selectionEnd = texto.value.length;
};



// üíæ GUARDAR (PERMITE VAC√çO)
window.guardar = async () => {
  const ahora = new Date().toLocaleString("es-AR");

  await setDoc(
    doc(db, "pacientes", "paciente_" + pacienteActual),
    {
      historial: texto.value,
      ultimaActualizacion: ahora
    },
    { merge: true }
  );

  texto.disabled = true;
  btnGuardar.disabled = true;
  fecha.innerText = "√öltima actualizaci√≥n: " + ahora;
};

// üîô VOLVER
window.volver = () => {
  editor.style.display = "none";
  lista.style.display = "grid";
};

// üìÑ PDF
window.exportarPDF = () => {
  const w = window.open("", "_blank");
  w.document.write(`<pre>${texto.value || "Sin historial"}</pre>`);
  w.document.close();
  w.print();
};
</script>
 
</body>
</html>
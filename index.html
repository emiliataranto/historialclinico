<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=, initial-scale=1.0">
    <title>Historial Clinico</title>
     <link rel="stylesheet" href="styles.css" />
</head>
<body>
<!-- LOGIN -->
<div id="login">
  <h1>Acceso autorizado</h1>
  <input type="email" id="email" placeholder="Email"><br><br>
  <input type="password" id="password" placeholder="Contrase√±a"><br><br>
 <button type="button" onclick="login()">Ingresar</button>

  <p id="error" style="color:red;"></p>
</div>

<!-- APP -->
<div id="app" style="display:none;">
  <h1>Historial Cl√≠nico</h1>
  <p class="subtitulo">Seleccion√° un paciente</p>

  <button onclick="logout()">Cerrar sesi√≥n</button>
  <br><br>
  
 <div class="buscador-container">
  <input
    type="text"
    id="buscador"
    placeholder="Buscar paciente‚Ä¶"
    onkeyup="filtrarPacientes()"
  >
</div>

  <div id="lista" class="grid">
    <div class="card" onclick="abrirPaciente(1)">Paciente 1</div>
    <div class="card" onclick="abrirPaciente(2)">Paciente 2</div>
    <div class="card" onclick="abrirPaciente(3)">Paciente 3</div>
     <div class="card" onclick="abrirPaciente(4)">Paciente 4</div>
    <div class="card" onclick="abrirPaciente(5)">Paciente 5</div>
    <div class="card" onclick="abrirPaciente(6)">Paciente 6</div>
    <div class="card" onclick="abrirPaciente(7)">Paciente 7</div>
    <div class="card" onclick="abrirPaciente(8)">Paciente 8</div>
    <div class="card" onclick="abrirPaciente(9)">Paciente 9</div>
     <div class="card" onclick="abrirPaciente(10)">Paciente 10</div>
    <div class="card" onclick="abrirPaciente(11)">Paciente 11</div>
  </div>

  <div id="editor" class="editor" style="display:none;">
    <h1 id="titulo"></h1>
    <p id="fecha" style="font-size:14px; color:gray;"></p>

    <textarea id="texto" disabled></textarea>

    <div class="botones">
      <button onclick="editar()">Editar</button>
      <button onclick="guardar()" id="btnGuardar" disabled>Guardar</button>
      <br><br>
      <button onclick="exportarPDF()">üìÑ Descargar PDF</button>
      <button onclick="volver()">‚Üê Volver</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCTvanae1ksxlApSyzR5aVDKz0ES5H_tug",
    authDomain: "historial-clinico-e7239.firebaseapp.com",
    projectId: "historial-clinico-e7239",
    storageBucket: "historial-clinico-e7239.firebasestorage.app",
    messagingSenderId: "971331712533",
    appId: "1:971331712533:web:626701c07f6860e445401c"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let pacienteActual = null;

  // üîê LOGIN
  window.login = async () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    try {
      await signInWithEmailAndPassword(auth, email, password);
      document.getElementById("error").innerText = "";
    } catch (err) {
      document.getElementById("error").innerText =
        "Acceso denegado: datos incorrectos";
    }
  };

  // üö™ LOGOUT
  window.logout = async () => {
    await signOut(auth);
    document.getElementById("email").value = "";
    document.getElementById("password").value = "";
  };

  // üëÄ SESI√ìN
  onAuthStateChanged(auth, (user) => {
    if (user) {
      document.getElementById("login").style.display = "none";
      document.getElementById("app").style.display = "block";
    } else {
      document.getElementById("login").style.display = "block";
      document.getElementById("app").style.display = "none";
    }
  });

  // üìÇ ABRIR PACIENTE
  window.abrirPaciente = async (id) => {
    pacienteActual = id;

    lista.style.display = "none";
    editor.style.display = "block";
    titulo.innerText = `Paciente ${id}`;

    const ref = doc(db, "pacientes", "paciente_" + id);
    const snap = await getDoc(ref);

    if (snap.exists()) {
  texto.value = snap.data().historial || "";
  fecha.innerText = snap.data().ultimaActualizacion
    ? "√öltima actualizaci√≥n: " + snap.data().ultimaActualizacion
    : "Sin actualizaciones";
} else {
  texto.value = "";
  fecha.innerText = "Sin historial";
}

    texto.disabled = true;
    btnGuardar.disabled = true;
  };
  
  window.filtrarPacientes = () => {
  const texto = buscador.value.toLowerCase();
  document.querySelectorAll(".card").forEach(card => {
    card.style.display =
      card.innerText.toLowerCase().includes(texto)
        ? "block"
        : "none";
  });
};

  // ‚úèÔ∏è EDITAR
window.editar = () => {
  texto.disabled = false;
  btnGuardar.disabled = false;

  const hoy = new Date().toLocaleDateString("es-AR");
  const lineas = texto.value.split("\n");

  // Buscar la √∫ltima l√≠nea con contenido
  let ultimaLinea = "";
  for (let i = lineas.length - 1; i >= 0; i--) {
    if (lineas[i].trim() !== "") {
      ultimaLinea = lineas[i].trim();
      break;
    }
  }

  // Si la √∫ltima l√≠nea NO empieza con la fecha de hoy, agregar fecha
  if (!ultimaLinea.startsWith(hoy + ":")) {
    if (texto.value.trim() !== "") {
      texto.value += "\n\n";
    }
    texto.value += hoy + ": ";
  }

  // Cursor al final
  texto.focus();
  texto.selectionStart = texto.selectionEnd = texto.value.length;
};



  // üíæ GUARDAR
 window.guardar = async () => {
  const ahora = new Date();
  const fechaLegible = ahora.toLocaleString("es-AR");
  const fechaKey = ahora.toISOString().replace(/[:.]/g, "-");

  const pacienteRef = doc(db, "pacientes", "paciente_" + pacienteActual);
  const backupRef = doc(
    db,
    "backups",
    "paciente_" + pacienteActual,
    fechaKey
  );

  try {
    // Guardado principal
    await setDoc(
      pacienteRef,
      {
        historial: texto.value,
        ultimaActualizacion: fechaLegible
      },
      { merge: true }
    );

    // Backup autom√°tico
    await setDoc(backupRef, {
      historial: texto.value,
      fecha: fechaLegible
    });

    texto.disabled = true;
    btnGuardar.disabled = true;
    fecha.innerText = "√öltima actualizaci√≥n: " + fechaLegible;
    alert("Guardado correctamente");

  } catch (e) {
    alert("Error al guardar");
    console.error(e);
  }
};



    texto.disabled = true;
    btnGuardar.disabled = true;
    fecha.innerText = "√öltima actualizaci√≥n: " + ahora;
  };

  // üîô VOLVER
  window.volver = () => {
    editor.style.display = "none";
    lista.style.display = "grid";
  };
  
  texto.addEventListener("input", () => {
  const ahora = new Date().toLocaleString("es-AR");
  fecha.innerText = "Editando‚Ä¶ (" + ahora + ")";
});

  window.exportarPDF = () => {
  const contenido = texto.value || "Sin historial";
  const tituloPDF = `Historial Cl√≠nico - Paciente ${pacienteActual}`;

  const ventana = window.open("", "_blank");
  ventana.document.write(`
    <html>
      <head>
        <title>${tituloPDF}</title>
        <style>
          body { font-family: Arial; padding: 20px; }
          h1 { text-align: center; }
          pre { white-space: pre-wrap; font-size: 14px; }
        </style>
      </head>
      <body>
        <h1>${tituloPDF}</h1>
        <pre>${contenido}</pre>
      </body>
    </html>
  `);

  ventana.document.close();
  ventana.print();
};

  
</script>

 
</body>
</html>